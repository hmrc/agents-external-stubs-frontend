@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.agentsexternalstubsfrontend.models._
@import uk.gov.hmrc.agentsexternalstubsfrontend.ViewHelper
@import uk.gov.hmrc.agentsexternalstubsfrontend.views.html.main_template
@import uk.gov.hmrc.govukfrontend.views.html.components.FormWithCSRF
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukInput
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukTextarea
@import uk.gov.hmrc.agentsexternalstubsfrontend.views.html.navigationBar
@import uk.gov.hmrc.govukfrontend.views.viewmodels.input.Input
@import uk.gov.hmrc.govukfrontend.views.viewmodels.label.Label
@import uk.gov.hmrc.govukfrontend.views.viewmodels.content.Text
@import uk.gov.hmrc.govukfrontend.views.Implicits.RichInput
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukSelect
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukErrorSummary
@import uk.gov.hmrc.govukfrontend.views.viewmodels.errorsummary.ErrorSummary
@import uk.gov.hmrc.hmrcfrontend.views.Implicits.RichErrorSummary
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukCheckboxes
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukDateInput
@import uk.gov.hmrc.govukfrontend.views.viewmodels.dateinput.DateInput
@import uk.gov.hmrc.hmrcfrontend.views.Implicits.RichDateInput
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukRadios
@import uk.gov.hmrc.govukfrontend.views.viewmodels.button.Button
@import uk.gov.hmrc.govukfrontend.views.viewmodels.fieldset.Fieldset
@import uk.gov.hmrc.govukfrontend.views.viewmodels.fieldset.Legend
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukButton
@import uk.gov.hmrc.govukfrontend.views.viewmodels.select.Select
@import uk.gov.hmrc.govukfrontend.views.Implicits.RichSelect
@import uk.gov.hmrc.govukfrontend.views.viewmodels.select.SelectItem
@import uk.gov.hmrc.govukfrontend.views.viewmodels.hint.Hint
@import uk.gov.hmrc.govukfrontend.views.viewmodels.checkboxes.Checkboxes
@import uk.gov.hmrc.govukfrontend.views.viewmodels.checkboxes.CheckboxItem
@import uk.gov.hmrc.govukfrontend.views.Implicits.RichCheckboxes

@this(
        mainTemplate: main_template,
        form: FormWithCSRF,
        govukTextarea: GovukTextarea,
        govukInput: GovukInput,
        govukSelect: GovukSelect,
        navigationBar: navigationBar,
        govukErrorSummary: GovukErrorSummary,
        govukCheckboxes: GovukCheckboxes,
        govukRadios: GovukRadios,
        govukDateInput: GovukDateInput,
        govukButton: GovukButton)

@(userForm: Form[User], postUrl: Call, cancelCall: Call, userId: String, hasContinue: Boolean, context: PageContext)(implicit request: Request[_], messages: Messages)

@principalEnrolments = @{
    ViewHelper.buildTree("", userForm.data)("principalEnrolments")
}

@delegatedEnrolments = @{
    ViewHelper.buildTree("", userForm.data)("delegatedEnrolments")
}

@suspendedRegimes = @{
    ViewHelper.buildTree("", userForm.data)("suspendedRegimes")
}

@mainTemplate(title = Messages("user.title", userId), wide = true) {

    @navigationBar(context)

    <h1 class="govuk-heading-xl">@Messages("user.edit.header", userId)</h1>

    @if(userForm.hasErrors) {
        @govukErrorSummary(ErrorSummary().withFormErrorsAsText(userForm))
    }

    <p class="govuk-hint">
    @Messages("user.edit.description")
    </p>

    <div>
    @form(action = postUrl, 'id -> "userForm", 'novalidate -> "novalidate") {
        <div>
            <div class="form-field-group">

                @govukSelect(Select(
                    label = Label(content = Text(Messages("user.form.affinityGroup"))),
                    hint = Some(Hint(content = Text("If the user is an Admin of its group, then you might not be able to change this without changing groupId as well."))),
                    items = AffinityGroup.values.map(ag => SelectItem(value = Some(ag), text = ag))
                ).withFormField(userForm("affinityGroup")))

                @govukInput(Input(
                    label = Label(
                        content = Text(Messages("user.form.name")),
                    ),
                    classes = "govuk-input govuk-input--width-20"
                ).withFormField(userForm("name")))

                <div class="govuk-button-group">
                    @govukButton(Button(
                        content = if(hasContinue) Text(Messages("user.edit.update_and_continue")) else Text(Messages("user.edit.update")),
                        attributes = Map("id" -> "update")
                    ))

                    <a class="govuk-body govuk-link" href="@{cancelCall.url}">
                        @Messages("user.edit.cancel")
                    </a>
                </div>

                @govukSelect(Select(
                    label = Label(content = Text(Messages("user.form.credentialRole"))),
                    hint = Some(Hint(content = Text("If the user is an Admin of its group, then you might not be able to change this without changing groupId as well."))),
                    items = CredentialRole.values.map(role => SelectItem(value = Some(role), text = role))
                ).withFormField(userForm("credentialRole")))

                @govukSelect(Select(
                    label = Label(content = Text(Messages("user.form.credentialStrength"))),
                    items = CredStrength.values.map(strength => SelectItem(value = Some(strength), text = strength))
                ).withFormField(userForm("credentialStrength")))

                @if(userForm.data.get("affinityGroup").contains("Individual")) {
                    @govukSelect(Select(
                        label = Label(content = Text(Messages("user.form.confidenceLevel"))),
                        items = ConfidenceLevel.values.map(lvl => SelectItem(value = Some(lvl._1), text = lvl._2))
                    ).withFormField(userForm("confidenceLevel")))

                    @govukInput(Input(
                        label = Label(
                            content = Text(Messages("user.form.nino")),
                        ),
                        classes = "govuk-input govuk-input--width-10"
                    ).withFormField(userForm("nino")))

                    @govukDateInput(DateInput(
                        fieldset = Some(Fieldset(
                            legend = Some(Legend(
                                content = Text(Messages("user.form.dateOfBirth")),
                            ))
                        ))
                    ).withFormField(userForm("dateOfBirth")))
@*                    @dateFieldsFreeInlineLegend(userForm, "dateOfBirth",
                        '_legend -> Html("""<span class="h2-heading soft--ends">""" + Messages("user.form.dateOfBirth") + """</span>"""),
                        '_labelClass -> "soft--ends"
                    ) *@
                }

                @govukInput(Input(
                    label = Label(
                        content = Text(Messages("user.form.groupIdentifier")),
                    ),
                    classes = "govuk-input govuk-input--width-20"
                ).withFormField(userForm("groupId")))

                @if(userForm.data.get("affinityGroup").contains("Agent")) {
                    @govukInput(Input(
                        label = Label(
                            content = Text(Messages("user.form.agentCode")),
                        ),
                        classes = "govuk-input govuk-input--width-20"
                    ).withFormField(userForm("agentCode")))

                    @govukInput(Input(
                        label = Label(
                            content = Text(Messages("user.form.agentFriendlyName")),
                        ),
                        classes = "govuk-input govuk-input--width-20"
                    ).withFormField(userForm("agentFriendlyName")))
                }

                <a name="address"></a>

                @govukInput(Input(
                    label = Label(content = Text(Messages("user.form.address"))),
                    attributes = Map("maxlength" -> "35"),
                    classes = "govuk-input govuk-input--width-20",
                    formGroupClasses = "govuk-!-margin-bottom-1"
                ).withFormField(userForm("address.line1")))

                @govukInput(Input(
                    attributes = Map("maxlength" -> "35"),
                    classes = "govuk-input govuk-input--width-20",
                    formGroupClasses = "govuk-!-margin-bottom-1"
                ).withFormField(userForm("address.line2")))

                @govukInput(Input(
                    attributes = Map("maxlength" -> "35"),
                    classes = "govuk-input govuk-input--width-20",
                    formGroupClasses = "govuk-!-margin-bottom-1"
                ).withFormField(userForm("address.line3")))

                @govukInput(Input(
                    attributes = Map("maxlength" -> "35"),
                    classes = "govuk-input govuk-input--width-20",
                ).withFormField(userForm("address.line4")))

                @govukInput(Input(
                    label = Label(
                        content = Text(Messages("user.form.address.postcode"))
                    ),
                    attributes = Map("maxlength" -> "10"),
                    classes = "govuk-input govuk-input--width-10"
                ).withFormField(userForm("address.postcode")))

                @govukSelect(Select(
                    label = Label(content = Text(Messages("user.form.address.countryCode"))),
                    items = CountryCodes.values.map(cc => SelectItem(value = Some(cc._1), text = cc._2))
                ).withFormField(userForm("address.countryCode")))

            </div>

            <div class="govuk-button-group">
                @govukButton(Button(
                    content = if(hasContinue) Text(Messages("user.edit.update_and_continue")) else Text(Messages("user.edit.update")),
                    attributes = Map("id" -> "update")
                ))

                <a class="govuk-body govuk-link" href="@{cancelCall.url}">
                    @Messages("user.edit.cancel")
                </a>
            </div>

            @if(userForm.data.get("affinityGroup").nonEmpty && !userForm.data.get("affinityGroup").contains("none")) {
                <a name="enrolments"></a>
                <h2>Principal enrolments</h2>

                <div id="principalEnrolments" class="form-group" style="text-align: right">
                    <table style="width: 100%" class="govuk-table">
                        <colgroup>
                            <col width="30%">
                            <col width="30%">
                            <col width="30%">
                            <col width="10%">
                        </colgroup>
                        <thead class="govuk-table__head">
                            <th class="govuk-table__header">Service key</th>
                            <th class="govuk-table__header">Identifier Name</th>
                            <th class="govuk-table__header">Identifier Value</th>
                            <th class="govuk-table__header"></th>
                        </thead>

                        @for(enrolment <- principalEnrolments) {
                            @for((identifier, i) <- enrolment(".identifier").zipWithIndex) {
                                <tr id="principalEnrolment-@i-row" class="govuk-table__row">
                                    @if(i == 0) {
                                        <td class="govuk-table__cell" rowspan="@{
                                            enrolment(".identifier").size
                                        }" style="vertical-align: top;">
                                            @govukInput(Input(
                                                formGroupClasses = "govuk-!-margin-bottom-0"
                                            ).withFormField(userForm(s"${enrolment.key}.key")))
                                        </td>
                                    }

                                <td class="govuk-table__cell">
                                    @govukInput(Input(
                                        formGroupClasses = "govuk-!-margin-bottom-0"
                                    ).withFormField(userForm(s"${identifier.key}.key")))
                                </td>
                                <td class="govuk-table__cell">
                                    @govukInput(Input(
                                        formGroupClasses = "govuk-!-margin-bottom-0"
                                    ).withFormField(userForm(s"${identifier.key}.value")))
                                </td>
                                <td class="govuk-table__cell">
                                    <a style="text-decoration: underline;
                                        cursor: pointer;" onclick="document.getElementById('principalEnrolment-@i-row').remove()">
                                                Remove
                                    </a>
                                </td>
                                </tr>
                            }
                        }

                        <tr class="govuk-table__row">
                            <td class="govuk-table__cell">
                                @govukInput(Input(
                                    formGroupClasses = "govuk-!-margin-bottom-0"
                                ).withFormField(userForm(s"principalEnrolments[${principalEnrolments.size}].key")))
                            </td>
                            <td class="govuk-table__cell">
                                @govukInput(Input(
                                    formGroupClasses = "govuk-!-margin-bottom-0"
                                ).withFormField(userForm(s"principalEnrolments[${principalEnrolments.size}].identifiers[0].key")))
                            </td>
                            <td class="govuk-table__cell">
                                @govukInput(Input(
                                    formGroupClasses = "govuk-!-margin-bottom-0"
                                ).withFormField(userForm(s"principalEnrolments[${principalEnrolments.size}].identifiers[0].value")))
                            </td>
                            <td class="govuk-table__cell">
                            </td>
                        </tr>

                    </table>

                </div>
            }

            @if(userForm.data.get("affinityGroup").contains("Agent")) {
                <a name="delegated"></a>
                <h2>Delegated enrolments</h2>

                <span class="govuk-hint">Only Agents can have delegated enrolments.</span>

                <div id="delegatedEnrolments" class="form-group" style="text-align: right">
                    <table class="govuk-table" style="width: 100%">
                        <colgroup>
                            <col width="30%">
                            <col width="30%">
                            <col width="30%">
                            <col width="10%">
                        </colgroup>
                        <tr class="govuk-table__row">
                            <th class="govuk-table__header">Service key</th>
                            <th class="govuk-table__header">Identifier Name</th>
                            <th class="govuk-table__header">Identifier Value</th>
                            <th class="govuk-table__header"></th>
                        </tr>

                        @for(enrolment <- delegatedEnrolments) {
                            @for((identifier, i) <- enrolment(".identifier").zipWithIndex) {
                                <tr id="delegatedEnrolment-@i-row">
                                    @if(i == 0) {
                                        <td class="govuk-table__cell" rowspan="@{
                                            enrolment(".identifier").size
                                        }" style="vertical-align: top;">
                                            @govukInput(Input(
                                                formGroupClasses = "govuk-!-margin-bottom-0"
                                            ).withFormField(userForm(s"${enrolment.key}.key")))
                                        </td>
                                    }

                                <td class="govuk-table__cell">
                                    @govukInput(Input(
                                        formGroupClasses = "govuk-!-margin-bottom-0"
                                    ).withFormField(userForm(s"${identifier.key}.key")))
                                </td>
                                <td class="govuk-table__cell">
                                    @govukInput(Input(
                                        formGroupClasses = "govuk-!-margin-bottom-0"
                                    ).withFormField(userForm(s"${identifier.key}.value")))
                                </td>
                                <td class="govuk-table__cell">
                                    <a style="text-decoration: underline;
                                        cursor: pointer;" onclick="document.getElementById('delegatedEnrolment-@i-row').remove()">
                                            Remove
                                    </a>
                                </td>
                                </tr>
                            }
                        }

                        <tr class="govuk-table__row">
                            <td class="govuk-table__cell">
                                @govukInput(Input(
                                    formGroupClasses = "govuk-!-margin-bottom-0"
                                ).withFormField(userForm(s"delegatedEnrolments[${delegatedEnrolments.size}].key")))
                            </td>
                            <td class="govuk-table__cell">
                                @govukInput(Input(
                                    formGroupClasses = "govuk-!-margin-bottom-0"
                                ).withFormField(userForm(s"delegatedEnrolments[${delegatedEnrolments.size}].identifiers[0].key")))
                            </td>
                            <td class="govuk-table__cell">
                                @govukInput(Input(
                                    formGroupClasses = "govuk-!-margin-bottom-0"
                                ).withFormField(userForm(s"delegatedEnrolments[${delegatedEnrolments.size}].identifiers[0].value")))
                            </td>
                            <td class="govuk-table__cell">

                            </td>
                        </tr>

                    </table>

                </div>
            }

            @if(userForm.data.get("affinityGroup").isEmpty || userForm.data.get("affinityGroup").contains("none")) {
                <a name="stride"></a>
                <h2>Stride roles</h2>

                <span class="govuk-hint">
                    Only HMRC internal staff can have STRIDE roles. Provide role names comma separated.</span>

                @govukInput(Input(
                    attributes = Map("maxlength" -> "60")
                ).withFormField(userForm("strideRoles")))
            }

            @if(userForm.data.get("affinityGroup").contains("Agent")) {
                <a name = "suspendedRegimes"></a>
                <h2>Suspended Regimes</h2>
                <span class="govuk-hint">Only Agents can be suspended. Valid Regimes: ITSA, VATC, TRS, CGT, PPT, IRV, ALL, AGSV</span>

                <div id="suspendedRegimes" class="form-group" style="text-align: right">
                    <table class="govuk-table" style="width: 100%">
                        <colgroup>
                            <col width="30%">
                            <col width="10%">
                        </colgroup>
                        <tr class="govuk-table__row">
                            <th class="govuk-table__header">Regime</th>
                            <th class="govuk-table__header"></th>
                        </tr>
                        @for((suspendedService, index) <- suspendedRegimes.zipWithIndex) {
                            <tr id="suspendedRegimes-@index-row">
                                <td style="vertical-align: top;">
                                    @govukInput(Input(
                                        classes = "govuk-input--width-10",
                                        formGroupClasses = "govuk-!-margin-bottom-0"
                                    ).withFormField(userForm(s"suspendedRegimes[$index]")))
                                </td>
                                <td class="govuk-table__cell">
                                    <a style="text-decoration: underline;
                                        cursor: pointer;" onclick="document.getElementById('suspendedRegimes-@index-row').remove()">
                                            Remove
                                    </a>
                                </td>
                            </tr>
                        }
                        <tr class="govuk-table__row">
                            <td class="govuk-table__cell">
                                @govukInput(Input(
                                    classes = "govuk-input--width-10",
                                    formGroupClasses = "govuk-!-margin-bottom-0"
                                ).withFormField(userForm(s"suspendedRegimes[${suspendedRegimes.size}]")))
                            </td>
                            <td class="govuk-table__cell"></td>
                        </tr>
                    </table>
                </div>

            }


            <h2>Specials</h2>

            @govukCheckboxes(Checkboxes(
                items = Seq(CheckboxItem(
                    content = Text(Messages("user.form.isNonCompliant")),
                    hint = Some(Hint(content = Text(Messages("user.form.isNonCompliant.hint"))))
                ))
            ).withFormField(userForm("isNonCompliant")))

            <div class="govuk-button-group">
                @govukButton(Button(
                    content = if(hasContinue) Text(Messages("user.edit.update_and_continue")) else Text(Messages("user.edit.update")),
                    attributes = Map("id" -> "update")
                ))

                <a class="govuk-body govuk-link" href="@{cancelCall.url}">
                    @Messages("user.edit.cancel")
                </a>
            </div>

            </fieldset>

            }
    </div>

}